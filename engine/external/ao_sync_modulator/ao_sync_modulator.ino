/*At 100 Hz checkerboard scanning 1/(100 * 48 ) -> min 200 us pulses 
 * are generated by ao. Therefore 60-100 us delay should be well detectable.
 * 
 * 
 * */
 
#define DELAY 100
#define SYNCIN 3
#define SYNCOUT 4
#define COUNTER_MODE 1
#define PULSE_DELAY_MODE 2
#define MODE COUNTER_MODE
#define COUNTER_PERIOD 48
#define OFFCOUNTS 2
#define LOWINPUTTIMEOUT 1000//ms
byte syncin;
byte counter;
unsigned long inputlowstarted,now;

ISR(INT1_vect) {
  cli();
  syncin=PIND&(1<<SYNCIN);
#if (MODE==PULSE_DELAY_MODE)
  if (syncin!=0)
  {
    delayMicroseconds(DELAY);
    PORTD|=1<<SYNCOUT;
  }
  else
  {
    PORTD&=~(1<<SYNCOUT);
  }
#elif (MODE==COUNTER_MODE)
  if (syncin!=0)//rising edge
  {
    now=millis();
    if (now-inputlowstarted>LOWINPUTTIMEOUT)//If syncin was at LOW for more than LOWINPUTTIMEOUT, reset counter
    {
      counter=0;
    }
    if (counter==COUNTER_PERIOD-OFFCOUNTS+1)
    {
      PORTD&=~(1<<SYNCOUT);
    }
    else if (counter==COUNTER_PERIOD)
    {
      counter=0;
    }
    else
    {
      PORTD|=1<<SYNCOUT;
    }
    counter++;
  }
  else
  {
    inputlowstarted=millis();
  }
#endif
  
  
  sei();
}


void setup() {
  counter=0;
  DDRD&=~(1<<SYNCIN);//int1
  DDRD|=(1<<SYNCOUT);
  EICRA|=1<<2;//falling edges
  EIMSK|=2;
  sei();
  
}

void loop() {
}
